# ユーザーガイド

Walicordの基本的な使い方と高度な機能について説明します。

## 基本的なワークフロー

1. **経費を記録する**: 誰かが支払った経費を報告します。
2. **清算プランを確認する**: 現在の貸し借り状況を確認します。
3. **決済を実行する**: お金を返して清算します。

### 1. 経費の記録

最も頻繁に行う操作です。

**推奨フォーマット（省略記法）**:
```
金額 [通貨] 宛先メンバー
```

例:
```
1000円 @花子
1000 to @Hanako
```

**明示的なフォーマット**:
```
支払者 が 受取人 に 金額 立て替えた
```

例:
```
@太郎 が @花子 に 1000円 立て替えた
@Taro paid 1000 to @Hanako
```

### 2. 清算プランの確認

現在の残高と、誰が誰にいくら支払えばよいかの最適化されたプランを表示します。

コマンド:
```
!清算確認
!review
```

ボットは残高表と送金リストを画像で返信します。

### 3. 決済の実行

実際にお金の受け渡しが完了したら、システム上で清算を行います。これにより残高がリセット（または減額）されます。

コマンド:
```
!settleup メンバーA メンバーB ...
!確定 メンバーA メンバーB ...
```

例:
```
# 太郎と花子の間だけで清算
!settleup @太郎 @花子

# チーム全員で清算
!settleup チーム
```

---

## 便利な機能

### メンバーの指定方法

- **個別に指定**: `@太郎 @花子`
- **全員指定**: `MEMBERS` （チャンネル内の記録されている全メンバー）
- **グループ指定**: 定義済みのグループ名（例: `team_a`）

### グループの定義

よく使うメンバーのセットに名前を付けられます。

```
チームA := @太郎 @花子 @次郎
```

定義後は `1000 to チームA` のように使用できます。

### 割り勘の対象

複数人を指定すると、金額は均等に割り勘されます。

```
3000 to @A @B @C
# => A, B, C がそれぞれ1000円ずつ受け取った（借金した）ことになる
```

### 重み付け割り勘

メンバーごとに異なる割合で割り勘できます。メンションの後に `*重み` を付けます。

```
3000 @A*2 @B*0 @C
# A: 2000円 (重み2), B: 0円 (重み0), C: 1000円 (重み1・省略時)
```

**使用例**:
- 大人は大人料金、子供は子供料金で割り勘: `10000 @大人A*2 @大人B*2 @子供*1`
- 一部のメンバーの分を誰かが立て替える: `3000 @A*2 @B*0 @C*0` (Aが全額負担)
- 重み0でメンバーは残すが負担なし: `6000 @A*3 @B*2 @C*1`

**注意**:
- 重みを省略した場合は1として扱われます
- すべての重みが0の場合はエラーになります

**集合演算との関係**:
重みは集合演算に参加しません。まず集合演算でメンバーセットが確定し、その後に重みが適用されます。

```
# 集合演算の例
(@A*2 @B) ∪ @C     # => {A, B, C}, 重み: A=2, B,C=1
@A*2 ∪ @A*3        # => {A}, 重み: A=3 (後勝ち)
(@A*2 @B) - @A     # => {B}, 重み: B=1 (Aは分配対象から除外)
```

グループ参照（`MEMBERS`や定義済みグループ）には重みを付けられません。グループメンバーに個別の重みを設定する場合は、グループを展開して個別に記述してください。

### セット演算

メンバー指定時に集合演算が使えます。

- **和集合 (∪, ,)**: `チームA, @ゲスト` （チームAとゲスト）
- **差集合 (-)**: `MEMBERS - @欠席者` （全員から欠席者を除く）
- **積集合 (∩)**: `チームA ∩ チームB` （両方に所属する人）

### 現金配慮（cash）

現金でのやり取りを優先したいメンバーを指定できます。

- `!member set <set_expr> cash`
- `!cash` (本人のみ)
- `!settleup <set_expr> --cash <set_expr>`

cash指定は送金構築のみに影響します。`!review` でも有効です。
解除は該当するメッセージを削除してください。

### コメント

記録にメモを残せます。

```
1000円 @花子 // ランチ代
1000円 /* 交通費 */ @次郎
```

### その他コマンド

- `!variables`: 現在定義されているグループ変数の一覧を表示します。
