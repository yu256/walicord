# walicord

Discord上で共有経費を追跡し、グループメンバー間の最適な債務決済を計算するDiscordボットです。

## 機能

- **経費記録**: カスタムDSL（英語/日本語対応）を使用した経費の記録
- **メンバー管理**: Discordメンション（`<@userid>`）を使った直接参照
- **残高計算**: 記録された全取引に基づく各メンバーの純残高の計算
- **債務決済の最適化**: 線形計画法を使用した決済取引の最小化
- **変数表示**: `!variables` コマンドで定義されたグループとそのメンバーを表示
- **複数チャンネル対応**: 複数のDiscordチャンネルで同時に動作可能
- **決済コマンド**: `!settleup` / `!確定` で特定メンバー集合の決済を即時反映
- **画像出力**: 残高表と決済プランをPNGで返信

## 技術スタック

- **Rust**: メインプログラミング言語
- **serenity**: Discord APIクライアント
- **tokio**: 非同期ランタイム
- **nom**: DSLパーサー
- **good_lp**: 混合整数線形計画問題ソルバー
- **dashmap**: 並行HashMap
- **tracing**: 構造化ログ
- **indexmap**: 順序保持HashMap
- **resvg / tiny-skia**: SVGからPNGへのレンダリング
- **dotenvy**: 環境変数の読み込み
- **thiserror**: エラーハンドリング

## プロジェクト構成

このプロジェクトは8つのクレートで構成されるRustワークスペースです:

- **walicord**: Discord APIとの連携を担当するメインのDiscordボットアプリケーション
- **walicord-application**: メッセージ処理やユースケースをまとめるアプリケーション層
- **walicord-domain**: 残高計算や決済ロジックのドメインモデル
- **walicord-parser**: DSLパーサーライブラリ
- **walicord-calc**: 債務決済最適化ライブラリ
- **walicord-infrastructure**: パーサーと最適化ソルバーのアダプタ
- **walicord-presentation**: 残高表と決済表のSVG/テキスト出力
- **walicord-i18n**: 表示メッセージのローカライズ

## セットアップ

1. Rustをインストール
2. `.env`ファイルにDiscordボットトークンと対象チャンネルIDを設定:
   ```
   DISCORD_TOKEN="YOUR_DISCORD_BOT_TOKEN"
   TARGET_CHANNEL_IDS="CHANNEL_ID_1,CHANNEL_ID_2" # カンマ区切りで複数指定可能
   ```
3. `cargo run --release`で実行

### 言語切り替え（features）

デフォルトは日本語です。英語のみを使いたい場合は`en`を指定します。

```sh
cargo run --release --features en
```

日本語のみを明示する場合は`ja`を指定します。

```sh
cargo run --release --features ja
```

### Unix系での依存関係

PNG出力のため、Unix系環境では`fontconfig`が必要になることがあります。日本語表示を安定させたい場合は`Noto Sans CJK JP`の導入を推奨します。

## 使い方

1. チャンネルで経費を記録（Discordメンションを使用）:
   ```
   <@123456789> lent 100 to <@987654321>
   <@123456789> が <@987654321> に 100 貸した
   ```
2. グループを定義する場合（オプション）:
   ```
   team := <@123456789> <@987654321>
   ```
3. `!variables` コマンドで現在のグループとメンバーの定義を確認
4. `!evaluate` コマンドで決済プランを計算
5. `!settleup` または `!確定` コマンドで特定のメンバー集合の決済計算:
   ```
   !settleup <@123456789> <@987654321>
   !確定 team - <@123456789>
   ```

## 構文について

### メンバーの指定

メンバーはDiscordのメンション形式で指定します:

```
<@123456789>
<@!123456789>  # ニックネーム付きメンション
```

複数のメンバーを指定する場合は、スペース区切りで記述します:

```
<@123456789> <@987654321> <@111222333>
```

### 文の種類

DSLには3種類のステートメントがあります:

### 1. グループ宣言

メンバーのグループを定義します:

```
group_name := <@123456789> <@987654321>
```

- `group_name`: グループの識別子
- メンバーはスペース区切りで指定します

### 2. 支払い記録

支払いを記録します。4つの構文パターンがサポートされています:

#### パターン1: 日本語(貸し手主語)

```
{payer} が {payee} に {amount} 貸した
```

#### パターン2: 英語(貸し手主語)

```
{payer} lent {amount} to {payee}
```

#### パターン3: 日本語(借り手主語)

```
{payee} が {payer} から {amount} 借りた
```

#### パターン4: 英語(借り手主語)

```
{payee} borrowed {amount} from {payer}
```

### 3. コマンド

```
!variables
!evaluate
!settleup MEMBERS - Alice
```

- `!variables`: グループとメンバー定義の一覧を表示
- `!evaluate`: 現在までの記録を元に決済プランを計算
- `!settleup` / `!確定`: 指定メンバー集合の決済を即時反映し、その結果を表示

### 識別子のルール

識別子(メンバー名、グループ名)には以下の文字が使用できます:

- 英数字
- アンダースコア(`_`)
- ハイフン(`-`)
- 日本語文字(ひらがな、カタカナ、漢字)

### 金額の表記

金額は以下の形式で記述できます:

- `1000` (数値のみ)
- `¥1000` (円記号付き)
- `1000円` (「円」付き)
- `1000えん` (ひらがな)
- `1000yen` (英語)

### セット演算子

グループ宣言や支払い記録の`{payer}`や`{payee}`には、以下のセット演算子を使った複雑な式も記述できます。

- **和集合**: `A ∪ B` または `<@123> <@456>` (メンションの場合はスペース区切り)
- **積集合**: `A ∩ B`
- **差集合**: `A - B`
- **括弧**: `(A ∪ B) ∩ C`

**注意**: グループ名とメンションを組み合わせる場合は、明示的に `∪` 演算子を使用してください:
```
team ∪ <@123456789>
```

### キーワードのバリエーション

DSLは日本語と英語の両方をサポートしています:

| 意味   | 日本語             | 英語                |
|--------|--------------------|---------------------|
| 借りた | かりた、借りた     | borrowed, BORROWED  |
| から   | から               | from, FROM          |
| 貸した | 貸した、かした     | lent, LENT          |
| に     | に                 | to, TO              |

### バリデーションルール

パーサーは以下のバリデーションを実行します:

1. **未定義メンバーチェック**: 宣言されていないメンバーやグループが使用された場合、`UndefinedMember`エラーが発生します
2. **構文エラー**: パース失敗時は`SyntaxError`が発生します
