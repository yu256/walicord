# walicord

Discord上で共有経費を追跡し、グループメンバー間の最適な債務決済を計算するDiscordボットです。

## 機能

- **経費記録**: カスタムDSL（英語/日本語対応）を使用した経費の記録
- **メンバー管理**: Discordチャンネルのトピックからメンバーを定義
- **残高計算**: 記録された全取引に基づく各メンバーの純残高の計算
- **債務決済の最適化**: 線形計画法を使用した決済取引の最小化

## 技術スタック

- **Rust**: メインプログラミング言語
- **serenity** Discord APIクライアント
- **tokio** 非同期ランタイム
- **nom** DSLパーサー
- **microlp** 線形計画法ソルバー
- **dashmap** 並行HashMap
- **tracing**: 構造化ログ

## プロジェクト構成

このプロジェクトは3つのクレートで構成されるRustワークスペースです:

- **walicord**: メインのDiscordボットアプリケーション
- **walicord-parser**: DSLパーサーライブラリ
- **walicord-calc**: 債務決済最適化ライブラリ

## セットアップ

1. Rustをインストール
2. `.env`ファイルにDiscordボットトークンを設定
3. `cargo run --release`で実行

## 使い方

1. Discordチャンネルのトピックにメンバーを定義:  
   ```
   MEMBERS := Alice, Bob, Carol
   ```
2. チャンネルで経費を記録:  
   ```
   Alice lent 100 to Bob
   Alice が Bob に 100 貸した
   ```
3. `!evaluate`コマンドで決済プランを計算

## 構文について

### MEMBERSの宣言

チャンネルのトピックで、参加メンバーを宣言する必要があります:

```
MEMBERS := name1, name2, name3
```

## 文の種類

DSLには2種類のステートメントがあります:

### 1. グループ宣言

メンバーのグループを定義します:

```
group_name := member1, member2
```

- `group_name`: グループの識別子
- `member1, member2`: グループに含まれるメンバー(カンマ区切り)

### 2. 支払い記録

支払いを記録します。4つの構文パターンがサポートされています:

#### パターン1: 日本語(貸し手主語)

```
{payer} が {payee} に{amount}貸した
```

#### パターン2: 英語(貸し手主語)

```
{payer} lent {amount} to {payee}
```

#### パターン3: 日本語(借り手主語)

```
{payee} が {payer} から{amount}借りた
```

#### パターン4: 英語(借り手主語)

```
{payee} borrowed {amount} from {payer}
```

## 識別子のルール

識別子(メンバー名、グループ名)には以下の文字が使用できます:

- 英数字
- アンダースコア(`_`)
- ハイフン(`-`)
- 日本語文字(ひらがな、カタカナ、漢字)

## 金額の表記

金額は以下の形式で記述できます:

- `1000` (数値のみ)
- `¥1000` (円記号付き)
- `1000円` (「円」付き)
- `1000えん` (ひらがな)
- `1000yen` (英語)

## キーワードのバリエーション

DSLは日本語と英語の両方をサポートしています:

| 意味   | 日本語             | 英語                |
|--------|--------------------|---------------------|
| 借りた | かりた、借りた     | borrowed, BORROWED  |
| から   | から               | from, FROM          |
| 貸した | 貸した、かした     | lent, LENT          |
| に     | に                 | to, TO              |

## バリデーションルール

パーサーは以下のバリデーションを実行します:

1. **未定義メンバーチェック**: 宣言されていないメンバーやグループが使用された場合、`UndefinedMember`エラーが発生します
2. **構文エラー**: パース失敗時は`SyntaxError`が発生します
