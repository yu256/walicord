# walicord

Discord上で共有経費を追跡し、グループメンバー間の最適な債務決済を計算するDiscordボットです。

## 機能

- **経費記録**: カスタムDSL（英語/日本語対応）を使用した経費の記録
- **メンバー管理**: Discordメンション（`<@userid>`）を使った直接参照
- **残高計算**: 記録された全取引に基づく各メンバーの純残高の計算
- **債務決済の最適化**: 線形計画法を使用した決済取引の最小化
- **変数表示**: `!variables` コマンドで定義されたグループとそのメンバーを表示
- **複数チャンネル対応**: 複数のDiscordチャンネルで同時に動作可能
- **決済コマンド**: `!settleup` / `!確定` で特定メンバー集合の決済を即時反映
- **画像出力**: 残高表と決済プランをPNGで返信

## 技術スタック

- **Rust**: メインプログラミング言語
- **serenity**: Discord APIクライアント
- **tokio**: 非同期ランタイム
- **nom**: DSLパーサー
- **good_lp**: 混合整数線形計画問題ソルバー
- **dashmap**: 並行HashMap
- **tracing**: 構造化ログ
- **indexmap**: 順序保持HashMap
- **resvg / tiny-skia**: SVGからPNGへのレンダリング
- **dotenvy**: 環境変数の読み込み
- **thiserror**: エラーハンドリング

## プロジェクト構成

このプロジェクトは8つのクレートで構成されるRustワークスペースです:

- **walicord**: Discord APIとの連携を担当するメインのDiscordボットアプリケーション
- **walicord-application**: メッセージ処理やユースケースをまとめるアプリケーション層
- **walicord-domain**: 残高計算や決済ロジックのドメインモデル
- **walicord-parser**: DSLパーサーライブラリ
- **walicord-calc**: 債務決済最適化ライブラリ
- **walicord-infrastructure**: パーサーと最適化ソルバーのアダプタ
- **walicord-presentation**: 残高表と決済表のSVG/テキスト出力
- **walicord-i18n**: 表示メッセージのローカライズ

## セットアップ

Discordボットが必要です。以下の手順でボットを作成・設定してください。

### オプション1: バイナリを直接ダウンロード（推奨）

1. [Releases](https://github.com/yu256/walicord/releases) から最新バージョンをダウンロード
2. `.env`ファイルにDiscordボットトークンと対象チャンネルIDを設定（後述）
3. バイナリを実行

### オプション2: ソースからビルド

1. Rustをインストール
2. `.env`ファイルにDiscordボットトークンと対象チャンネルIDを設定（後述）
3. `cargo run --release`で実行

### Discordボットの作成

1. [Discord Developer Portal](https://discord.com/developers/applications)で新しいアプリケーションを作成（Botユーザーは同時に作成されます）
2. **Bot** タブでBotを構成:
   - **Message Content Intent** にチェック（Privileged Intent）
   - **Server Members Intent** にチェック（Privileged Intent）
   - トークンをコピーして保存
3. **OAuth2 > URL Generator** タブでBotをサーバーに招待:
   - **bot** スコープを選択
   - 以下の権限を付与:
     - `Read Message History`
     - `Send Messages`
     - `Add Reactions`
   - 生成されたURLでBotをサーバーに招待

### 環境設定

`.env`ファイルにDiscordボットトークンと対象チャンネルIDを設定:
```
DISCORD_TOKEN="YOUR_DISCORD_BOT_TOKEN"
TARGET_CHANNEL_IDS="CHANNEL_ID_1,CHANNEL_ID_2" # カンマ区切りで複数指定可能
```

### 言語切り替え（features）

デフォルトは日本語です。英語のみを使いたい場合は`en`を指定します。

```sh
cargo run --release --features en
```

日本語のみを明示する場合は`ja`を指定します。

```sh
cargo run --release --features ja
```

### Unix系での依存関係

PNG出力のため、Unix系環境では`fontconfig`が必要になることがあります。日本語表示を安定させたい場合は`Noto Sans CJK JP`の導入を推奨します。

## 使い方

### 基本的な使い方

1. **経費を記録する**: 支払者は省略でき、投稿者が支払者として扱われます
   ```
   1000円 @花子
   1000 to @Hanako
   ```

2. **清算プランを確認する**: `!清算確認` / `!review` コマンドで最適な清算方法を計算
   ```
   !清算確認
   ```

3. **決済を実行する**: `!settleup` で特定メンバー間の決済を確定
   ```
   !settleup @太郎 @花子
   ```

### メンバーの指定方法

#### Discordメンションで指定
通常の Discord メンション機能を使ってユーザーを指定できます。メッセージを入力するときに `@` を入力してユーザー名を選択すると、Discordが自動的に `<@123456789>` の形式に変換します（表示上は `@太郎` のまま）。

```
1000円 @花子
@太郎 が @花子 に 1000 立て替えた
```

#### MEMBERSキーワード
`MEMBERS` は特別なキーワードで、チャンネル内の全員を指します：

```
3000 to MEMBERS
→ 太郎を含むチャンネル内の全員に均等に分配されます
  （例：3人のチャンネルなら、太郎は2000円の支払い、他2人は各1000円ずつ受け取り）
```

#### グループを定義する（オプション）
よく使うメンバーのグループに名前を付けられます：

```
チーム := @太郎 @花子 @次郎
5000 to チーム
```

### 支払いの記録方法

#### 省略記法（推奨）
```
1000円 @花子
1000 to @Hanako
```

#### 明示記法（任意）
```
@太郎 が @花子 に 1000円 立て替えた
@Taro paid 1000 to @Hanako
```

#### 金額の書き方
以下のいずれの形式でも記録できます：
- `1000` (数値のみ)
- `¥1000` (円記号付き)
- `1000円` / `1000えん` (日本語)
- `1000yen` (英語)
- `1000+200` / `1000*3` / `(1200+300)/3` (四則演算と括弧。割り算は割り切れる場合のみ)

### コマンド一覧

- **`!variables`**: 定義されているグループとメンバーの一覧を表示
- **`!清算確認`** / **`!review`**: 現在の残高と最適な清算プランを計算して表示
- **`!settleup メンバー`** / **`!確定 メンバー`**: 指定したメンバー間の決済を実行し、残高を清算

#### settleupの使用例
```
# 特定のメンバー間で決済
!settleup @太郎 @花子

# MEMBERSキーワードで全員決済
!settleup MEMBERS

# グループを使った決済
!settleup チーム

# 除外する場合（チーム全員から太郎を除く）
!settleup チーム - @太郎
```

## 高度な使い方

### コメント

`/* */` で囲んだ部分はコメントとして無視されます。メッセージ中のどこにでも挿入できます。
`//` は行末までのコメントとして扱われます。

```
1000円 /*ランチ*/ @花子
@太郎 /*交通費*/ が @花子 に 1000 立て替えた
!settleup /*除外*/ @太郎
1000円 @花子 // ランチ
// メモ
```

### 複数メンバーの指定

複数のメンバーを同時に指定する場合は、スペースまたはカンマで区切ります：

```
3000 to @花子 @次郎 @三郎
3000 to @花子, @次郎, @三郎
→ 3人で均等に分割（各1000円ずつ）
```

### セット演算

より複雑なメンバーの組み合わせには、以下の演算子が使えます：

- **和集合** (`∪`, `,`, `，`): 複数のグループを結合
  ```
  チームA ∪ チームB
  チームA, チームB
  ```
- **積集合** (`∩`): 共通メンバーのみ
  ```
  チームA ∩ チームB
  ```
- **差集合** (`-`): 特定メンバーを除外
  ```
  MEMBERS - @太郎
  チーム - @花子 - @次郎
  ```

**注意**: グループ名とメンションを組み合わせる場合は、明示的に `∪` または `,` を使用してください：
```
チーム ∪ @太郎
チーム, @太郎
```

### グループ名の命名規則

グループ名には以下の文字が使用できます：
- 英数字 (A-Z, a-z, 0-9)
- アンダースコア (`_`)
- ハイフン (`-`)
- 日本語文字（ひらがな、カタカナ、漢字）

例: `team_a`, `プロジェクトメンバー`, `営業部-東京`
